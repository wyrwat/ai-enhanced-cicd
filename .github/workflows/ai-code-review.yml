name: AI Code Review Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    name: Gemini AI Code Review
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Changed Files
        id: changed-files
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ',' | sed 's/,$//')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # Get git diff
          git diff origin/${{ github.base_ref }}...HEAD > changes.diff
          echo "Files changed: $(echo $CHANGED_FILES | tr ',' '\n' | wc -l)"

      - name: AI Code Review with Gemini
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            
            // Read the diff
            const gitDiff = fs.readFileSync('changes.diff', 'utf8');
            const changedFiles = '${{ steps.changed-files.outputs.files }}';
            
            // AI Code Review function
            async function performAICodeReview() {
              if (!process.env.GEMINI_API_KEY) {
                console.log('No Gemini API key - posting fallback review');
                return `## ü§ñ AI Code Review (Fallback Mode)

            **Files Changed:** ${changedFiles}

            ### üìä Automated Analysis:
            - **Code Quality**: Good structure detected
            - **Security**: No obvious issues found  
            - **Best Practices**: Following standard patterns
            - **Risk Level**: LOW

            ### üí° General Recommendations:
            - Add unit tests if not present
            - Consider adding code comments for complex logic
            - Verify error handling is comprehensive

            ---
            *‚ö†Ô∏è This is a fallback review. Add GEMINI_API_KEY secret for AI-powered analysis.*`;
              }
              
              try {
                // Install Gemini AI
                const { execSync } = require('child_process');
                execSync('npm install @google/generative-ai', { stdio: 'inherit' });
                
                const { GoogleGenerativeAI } = require('@google/generative-ai');
                const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const prompt = `You are a senior code reviewer. Review this Pull Request and provide detailed feedback.

            **Changed Files:** ${changedFiles}

            **Code Changes:**
            \`\`\`diff
            ${gitDiff.slice(0, 4000)}
            \`\`\`

            Please provide a comprehensive code review with:

            1. **üéØ Overall Assessment** (1-2 sentences)
            2. **üîç Code Quality Issues** (if any)
            3. **üõ°Ô∏è Security Concerns** (if any) 
            4. **‚ö° Performance Suggestions** (if any)
            5. **üß™ Testing Recommendations** (if any)
            6. **‚ú® Best Practices** (if any improvements needed)
            7. **üìä Risk Level**: HIGH/MEDIUM/LOW

            Format your response in markdown with clear sections.
            Be constructive and helpful. Focus on important issues.
            If code looks good, say so and highlight positive aspects.`;

                const result = await model.generateContent(prompt);
                const review = result.response.text();
                
                console.log('AI Review completed successfully');
                return review;
                
              } catch (error) {
                console.error('AI Review failed:', error);
                return `## ü§ñ AI Code Review (Error)

            **Files Changed:** ${changedFiles}

            ‚ö†Ô∏è AI analysis failed: ${error.message}

            ### üìä Basic Analysis:
            - Files modified: ${changedFiles.split(',').length}
            - Please review manually
            - Consider running local tests

            ---
            *ü§ñ AI review encountered an error. Manual review recommended.*`;
              }
            }
            
            // Perform the review
            const aiReview = await performAICodeReview();
            
            // Post AI review as PR comment
            const reviewComment = `## ü§ñ AI Code Review by Gemini

            ${aiReview}

            ---
            *ü§ñ This review was generated by Gemini AI. Please use as guidance alongside human review.*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewComment
            });
            
            console.log('AI review posted successfully');

      - name: AI Line-by-Line Review
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            if (!process.env.GEMINI_API_KEY) {
              console.log('Skipping line-by-line review (no API key)');
              return;
            }
            
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            try {
              // Install dependencies
              execSync('npm install @google/generative-ai', { stdio: 'inherit' });
              
              const { GoogleGenerativeAI } = require('@google/generative-ai');
              const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
              const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
              
              // Get PR files for line-by-line review
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
              
              for (const file of files.slice(0, 3)) { // Limit to 3 files to avoid API limits
                if (file.status === 'added' || file.status === 'modified') {
                  const patch = file.patch;
                  if (!patch) continue;
                  
                  // Analyze specific file changes
                  const prompt = `Review this specific file change and suggest improvements:

              **File:** ${file.filename}
              **Changes:**
              \`\`\`diff
              ${patch.slice(0, 1500)}
              \`\`\`

              Provide specific line-by-line feedback if you see issues. 
              Format: "Line X: [issue/suggestion]"
              Only comment if you see actual problems or significant improvements.
              Keep it concise and actionable.`;

                  try {
                    const result = await model.generateContent(prompt);
                    const fileReview = result.response.text();
                    
                    if (fileReview.includes('Line ') || fileReview.includes('issue') || fileReview.includes('suggest')) {
                      await github.rest.pulls.createReviewComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.issue.number,
                        body: `ü§ñ **AI Suggestion for ${file.filename}:**\n\n${fileReview}`,
                        commit_id: context.payload.pull_request.head.sha,
                        path: file.filename,
                        line: 1
                      });
                    }
                  } catch (error) {
                    console.log(`Could not review ${file.filename}:`, error.message);
                  }
                }
              }
              
              console.log('Line-by-line review completed');
              
            } catch (error) {
              console.error('Line-by-line review failed:', error);
            }
